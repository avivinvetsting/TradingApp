<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Backtest Report â€” {{ run_id }}</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, 'Helvetica Neue', Arial, sans-serif; margin: 24px; }
      h1, h2 { margin-bottom: 8px; }
      .grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
      .metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
      .metric { padding: 12px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
      .muted { color: #666; }
      .section { margin-bottom: 24px; }
      .k { font-weight: 600; }
    </style>
  </head>
  <body>
    <h1>Backtest Report</h1>
    <div class="muted">Run: <span class="k">{{ run_id }}</span> | Symbols: {{ symbols }} | Interval: {{ interval }}</div>

    <div class="section">
      <h2>Metrics</h2>
      <div class="metrics">
        <div class="metric">CAGR: {{ metrics.cagr | default('n/a') }}</div>
        <div class="metric">Sharpe: {{ metrics.sharpe | default('n/a') }}</div>
        <div class="metric">Sortino: {{ metrics.sortino | default('n/a') }}</div>
        <div class="metric">Max Drawdown: {{ metrics.max_drawdown | default('n/a') }}</div>
        <div class="metric">Calmar: {{ metrics.calmar | default('n/a') }}</div>
        <div class="metric">Hit Rate: {{ metrics.hit_rate | default('n/a') }}</div>
        <div class="metric">Turnover (notional): {{ metrics.turnover_notional | default('n/a') }}</div>
        <div class="metric">Time in market: {{ (metrics.time_in_market_ratio*100) if metrics and metrics.time_in_market_ratio is not none else 'n/a' }}%</div>
        <div class="metric">Peak gross exposure: {{ metrics.peak_gross_exposure | default('n/a') }}</div>
      </div>
    </div>
    <div class="section">
      <h2>Observability</h2>
      <div class="metrics">
        <div class="metric">Bars: {{ observability.counters.bars if observability and observability.counters else 'n/a' }}</div>
        <div class="metric">Approved orders: {{ observability.counters.orders_approved if observability and observability.counters else 'n/a' }}</div>
        <div class="metric">Fills: {{ observability.counters.fills if observability and observability.counters else 'n/a' }}</div>
        <div class="metric">Bar loop p50 (ms): {{ observability.timers.bar_loop_ms.p50 if observability and observability.timers and observability.timers.bar_loop_ms else 'n/a' }}</div>
        <div class="metric">Bar loop p95 (ms): {{ observability.timers.bar_loop_ms.p95 if observability and observability.timers and observability.timers.bar_loop_ms else 'n/a' }}</div>
        <div class="metric">Bars/sec: {{ observability.timers.bar_loop_ms.bars_per_sec if observability and observability.timers and observability.timers.bar_loop_ms else 'n/a' }}</div>
      </div>
    </div>

    <div class="grid">
      <div class="section">
        <h2>Equity Curve</h2>
        {{ equity_plot | safe }}
      </div>
      <div class="section">
        <h2>Drawdown</h2>
        {{ drawdown_plot | safe }}
      </div>
    </div>
  </body>
</html>
